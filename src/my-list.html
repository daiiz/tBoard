<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="./components/text-card.html">
<script src="./libs/jquery.js"></script>

<dom-module id="my-list">
  <template>

    <style include="shared-styles">
      #stage {
        width: 80%;
        margin: auto;
        margin-top: 24px;
      }

      .label {
        padding: 2px;
        font-size: 10pt;
        color: #444;
        padding-top: 10px;
      }

      .file {
        padding: 6px;
        background-color: #e1e1e1;
        border-radius: 4px;
        margin-bottom: 15px;
        box-sizing: border-box;
      }

      .stage-dragenter {
        background: #ccc;
      }
    </style>

    <div id="stage">
      <div class="file">
        <input type="file" id="file-form" accept="text/plain">
      </div>
      <div id="cards">
        <text-card num=Sample body="firebase init"></text-card>
      </div>
    </div>

  </template>

  <script>
    class MyList extends Polymer.Element {
      static get is() { return 'my-list'; }

      ready () {
        super.ready();
        this._bindEvents();
        console.info(888);
      }

      _bindEvents () {
        var self = this;
        var fileInput = this.shadowRoot.querySelector('#file-form');
        var $file = jQuery(fileInput);
        $file.on('change', e => {
          var fileReader = new FileReader();
          fileReader.onload = e => {
            var txt = e.target.result;
            var texts = txt.split('\n');
            self._renderTextCards(texts);
          }
          var file = e.target.files[0];
          if (file.type !== 'text/plain') return false;
          fileReader.readAsText(file);
          fileInput.value = '';
        });
      }

      _renderTextCards (texts=[]) {
        var cardsArea = this.shadowRoot.querySelector('#cards');
        if (texts.length > 0) {
          cardsArea.innerHTML = '';
        }

        var idx = 1;
        for (var i = 0; i < texts.length; i++) {
          var txt = texts[i].trim();
          if (txt.length === 0) continue;

          if (txt.startsWith('#')) {
            // ラベル
            var $label = $(`<div class="label">${txt.split("#")[1].trim()}</div>`);
            $(cardsArea).append($label);
          }else if (txt.startsWith('-')) {
            // 非表示
          }else {
            var textCard = document.createElement('text-card');
            textCard.body = txt;
            textCard.num = idx;
            cardsArea.appendChild(textCard);
            idx += 1;
          }
        }
      }

    }
    window.customElements.define(MyList.is, MyList);
  </script>
</dom-module>
